includes:
    - vendor/phpstan/phpstan-strict-rules/rules.neon
    - vendor/phpstan/phpstan-deprecation-rules/rules.neon
    - phpstan-baseline.neon

parameters:
    level: 6

    paths:
        - class

    excludePaths:
        - vendor
        - tests

    # XOOPS-specific settings
    bootstrapFiles:
        - phpstan-bootstrap.php

    # Treat XOOPS objects as universal crates
    universalObjectCratesClasses:
        - XoopsObject
        - XoopsModule
        - XoopsUser

    # Ignore XOOPS legacy patterns
    ignoreErrors:
        # Global variables from XOOPS core
        - '#Variable \$xoopsDB might not be defined#'
        - '#Variable \$xoopsUser might not be defined#'
        - '#Variable \$xoopsModule might not be defined#'
        - '#Variable \$xoopsModuleConfig might not be defined#'
        - '#Variable \$xoopsTpl might not be defined#'
        - '#Variable \$xoopsSecurity might not be defined#'

        # Legacy handler patterns
        - '#Call to an undefined method XoopsObjectHandler::#'
        - '#Call to an undefined method XoopsPersistableObjectHandler::#'

        # XOOPS function return types
        - '#Function xoops_getHandler has no return type#'
        - '#Function xoops_getModuleHandler has no return type#'

        # Smarty template assignments can be mixed
        - '#Cannot access offset .+ on mixed#'

        # Missing generics — legacy XOOPS code
        -
            identifier: missingType.generics

        # Strict rules — allow empty() in legacy patterns
        -
            identifier: empty.notAllowed

        # XOOPS language constants loaded at runtime
        - '#Constant _[A-Z_]+ not found#'

        # XOOPS core functions loaded at runtime
        - '#Function xoops_cp_header not found#'
        - '#Function xoops_cp_footer not found#'

        # Strict rules — constructor parent call not needed for XoopsObject
        # (XoopsObject::__construct is empty in XOOPS core)
        -
            identifier: constructor.missingParentCall

        # Strict rules — new static() needed for singleton pattern
        -
            identifier: new.static

        # Strict rules — short ternary is used in XOOPS patterns
        -
            identifier: ternary.shortNotAllowed

        # Strict rules — unused constructor parameters (Helper passed to handlers)
        -
            identifier: constructor.unusedParameter

        # Strict rules — boolean conditions with non-bool values
        -
            identifier: if.condNotBoolean

        # Strict rules — private constants accessed via static:: (XOOPS pattern)
        - '#Unsafe access to private constant .+ through static::#'

        # Handler return type covariance (insert/delete return mixed in subclass)
        - '#Return type .+ of method .+::(insert|delete)\(\) should be covariant with return type .+ of method .+::(insert|delete)\(\)#'

        # Handler methods return XoopsObject but docblocks promise typed arrays
        - '#should return array<.+> but returns array<int, XoopsObject>#'
        - '#should return array<.+> but returns array<int<0, max>, XoopsObject>#'
        - '#should return .+\|null but returns XoopsObject\|null#'

        # Iterable value type for $file arrays ($_FILES)
        -
            identifier: missingType.iterableValue

        # Casting to int something that is already int (safe, no-op)
        -
            identifier: cast.useless

        # Call to methods on XoopsObject instances returned by handlers
        - '#Call to an undefined method XoopsObject::#'

    # Type inference helpers
    typeAliases:
        XoopsObjectArray: 'array<int, XoopsObject>'

    checkMissingIterableValueType: true
    reportUnmatchedIgnoredErrors: false

    parallel:
        maximumNumberOfProcesses: 4

    phpVersion: 70400
